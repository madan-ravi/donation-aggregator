<!DOCTYPE html>
<html>
<head>
	<title>Donation Aggregator Service</title>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Lato:900|Montserrat|Roboto&display=swap" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="/static/styles/customstyles.css">
	<link rel="stylesheet" type="text/css" href="/static/styles/tagstyles.css">
	<link rel="stylesheet" type="text/css" href="/static/styles/navbar.css">
</head>
<body>
	<div class="bgimage">
		<img src="res/bg1.jpg" id="bgimage-img">
	</div>
	<div class="navbar">
		<div class="left-bar">
			<span><i class="material-icons">home</i><a href="#">Home</a></span>
			<span><i class="material-icons">person</i><a href="http://localhost:4000/profile">Profile</a></span>
			<span><i class="material-icons">list_alt</i><a href="http://localhost:4000/events">Events</a></span>
		</div>
		<div class="right-bar">
			<span><a href="#">Login</a></span>
		</div>
	</div>
	<div class="registerwindow">
        <div class="registerfraction">
            <div id="register-required">
                <span id="numerator">0</span>/<span id="denominator">1000</span>
            </div>
            <div id="register-load">

            </div>
        </div>
        <h4 id="register-blurb">Get Registered soon!</h4> 
		<div class="registerbutton">REGISTER</div>
		<br><br>
		<input id="register-count" placeholder="Enter expected number of registrations">
	</div>
	<div class="registerwindow" id="register-2">
		<div class="tagcontainer">
			<p id="save-changes">Edit Page</p>
			<input class="edit-mode" type="button" onclick="toggleEditingMode()" value="Edit Page">
			<p>Page color</p>
			<input type="color" onchange="colorChanger(this)" value="#3e8e3e">
		</div>	
	</div>
	<div class="centercontent">
		<div class="contentbody">
			<div class="contentcover">
				<div class="unloaded-cover-picture">
					<i class="material-icons">add</i>
					<input type="file" onchange="loadCoverPic(this)">
				</div>
				<div class="loaded-cover-picture">
					<img src="#">
				</div>
            </div>
            <div class="contentbox">
                <div class="eventtitle" id="event-title" contenteditable="false"> Raising money for orphaned children in Bangalore</div>
            
                <div class="tag-box">
					<div class="tag-holder">

					</div>
					<p class="tag" id="add-tag" onclick="displayTagSearch()">Add tag<i id="tag-add" class="material-icons">add</i></p>
					<div id="tag-container">
						<div id="search-tags">
							<input spellcheck=false id="choose-tag" placeholder="Search tag" onfocus="getTagsList()" onkeyup="getTagsList()">
							<div id="tag-suggestions">
			
							</div>
						</div>
					</div>
                </div>
            </div>
			<div class="contentbox overridegrid content-border">
                <div class="eventorganizer">
                    <h3 id="foundation-name" contenteditable="false">Ninaada Foundation</h3>
                </div>			
            </div>
			<div class="contentbox overridegrid content-border" style="border-bottom:1px solid rgba(0,0,0,0.1);border-top:1px solid rgba(0,0,0,0.1)"> 

				<div class="materials">
					<i class="material-icons" >my_location</i>
					<br>
					<input class="material-ip" id="location-id" value="Cubbon Park, Bangalore 560011">
				</div>
				<div class="materials">
					<i class="material-icons">date_range</i>
					<br>
					<input class="material-ip" type="datetime-local" id="event-date" value="12th February, 2020">
				</div>
				<div class="materials">
					<i class="material-icons">phone</i>
					<br>
					<input class="material-ip" id="phone-no" value="+91 987654321">
				</div>
				<div class="materials">
					<i class="material-icons">person</i>
					<br>
					<input class="material-ip" id="contact-name" value="Your mom">
				</div>
			</div>
			<div class="contentbox">
				<div class="element-div text-blocks">
					<div class="h3-container">
						<h3 class="about" id="event-head" contenteditable="false" spellcheck="false"> How we want to help</h3>
					</div>
					<p class="small-text" id="event-details" contenteditable="false" spellcheck="false">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
				</div>
			</div>
			<div class="contentbox">
				<div class="element-div">
					<div class="h3-container" id="widget-row-x">
						<button  onclick="delElement(this)"> <i class="material-icons">close</i></button>
					</div>
					<div class="flex-row-box">
						<div class="frame-box" onclick="loadWidgetMenu(this)">
							<div class="frame-button">
								<i class="material-icons">add</i>
							</div>
							<iframe></iframe>
						</div>
						<div class="frame-box" onclick="loadWidgetMenu(this)">
							<div class="frame-button">
								<i class="material-icons">add</i>
							</div>
							<iframe></iframe>
						</div>
						<div class="frame-box" onclick="loadWidgetMenu(this)">
							<div class="frame-button">
								<i class="material-icons">add</i>
							</div>
							<iframe></iframe>
						</div>
					</div>
				</div>
			</div>
            <div class="faqcontainer">
					<h3 class="about" spellcheck="false">FAQs</h3>
					<div class="faq">
						<div class="question">
							Are you also open to collecting some old clothes?
						</div>
						<div class="answer">
						Yes! All help is appreciated. 
						</div>
					</div>
					<div class="faq">
						<div class="question">
							Are you also open to collecting some old clothes?
						</div>
						<div class="answer">
						Yes! All help is appreciated. 
						</div>
					</div>
					<div class="faq">
						<div class="question">
							Are you also open to collecting some old clothes?
						</div>
						<div class="answer">
						Yes! All help is appreciated. 
						</div>
					</div>
					<div class="faq-ask">
						<input type="text" class="addfaq" placeholder="Ask a question">
						<div class="registerbutton" onclick="ask()">ASK QUESTION</div>
					</div>
				</div>
		</div>
	</div>

	<div class="widget-menu" id="widget-menu-1">
		<div class="close-div" onclick="loadWidgetMenu('close')">
			<h3>Widgets</h3>
			<i class="material-icons close-widget">close</i>
		</div>
		<div class="widgets" id="widget-1" onclick="addWidget('calendar.html')">

		</div>
		<div src="tagsys.html"  class="widgets" id="widget-2" onclick="addWidget('tagsys.html')">

		</div>
		<div class="widgets" id="widget-3">

		</div>
	</div>

	<div class="widget-menu" id="widget-menu-2">
		<div class="close-div" onclick="loadComponentMenu()">
			<h3>Components</h3>
			<i class="material-icons close-widget">close</i>
		</div>
		<div class="widgets" id="component-1" onclick="addComponents(1)">
			
		</div>
		<div class="widgets" id="component-2" onclick="addComponents(2)">

		</div>
		<div class="widgets" id="component-3" onclick="addComponents(3)">

		</div>
	</div>

	<script>
            var componentToggle = false
            var widgetToggle = false
            var selectedFrame = null
            var editMode = false
			var imageRows = 3
            function loadComponentMenu(){
                componentToggle = !componentToggle
                if(componentToggle && widgetToggle){
                    $("#widget-menu-2").animate({"right":"0"},"fast")
                    $("#widget-menu-1").animate({"right":"-350"},"fast")
					$(".registerwindow").animate({"right":"80px"},"fast")
                    widgetToggle = false
                }else{
                    if(componentToggle){
                        $("body").animate({"left":"-250px"},"fast")
						$("#register-2").animate({"right":"80px"},"fast")
                        $("#widget-menu-2").animate({"right":"0"},"fast")
						$(".registerwindow").animate({"right":"80px"},"fast")
                    }
                    else{
                        $("body").animate({"left":"0px"},"fast")
						$("#register-2").animate({"right":"370px"},"fast")
                        $("#widget-menu-2").animate({"right":"-350"},"fast")
						$(".registerwindow").animate({"right":"370px"},"fast")
                    }
                    
                }
                
            
            }


			$(".editable-p").on("focus",function(){
				if($(this).html()=="Sample Text"){
					$(this).html("&zwnj;")
				}
			})

			$(".editable-p").on("blur",function(){
				if($(this).html()=="\u200c"){
					$(this).html("Sample Text")
				}
			})
            
            function callLoaders(){
                followCount()
            }

            function delElement(ref){
                $(ref).parent().parent().parent().slideUp(350,function(){
                    $(this).remove()
                })

            }

			function delImgRow(ob){
				$(ob).parent().slideUp(function(){
					$(ob).parent().remove()
				})
			}

            function loadCoverPic(input){
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $($(input).parent().parent().children(".loaded-cover-picture").children()[0]).attr('src', e.target.result);
                        $(input).parent().parent().children(".loaded-cover-picture").show()
                        $(input).parent().css({"opacity":"0"})
						$("#bgimage-img").attr("src",e.target.result)
						$("body").css({"background":"none"})
                    };

                    reader.readAsDataURL(input.files[0]);
                }
            }

            function loadImage(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $($(input).parent().parent().children(".img-container-loaded").children()[0]).attr('src', e.target.result);
                        $(input).parent().parent().children(".img-container-loaded").show()
                        $(input).parent().css({"opacity":"0"})
                    };

                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            function loadWidgetMenu(frameParent){
                widgetToggle = true
                if(componentToggle && widgetToggle){
                    $("#widget-menu-1").animate({"right":"0"},"fast")
                    $("#widget-menu-2").animate({"right":"-350"},"fast")
					
                    componentToggle = false
                }
                else{
                    if(frameParent=='close'){
                        $("body").animate({"left":"0px"},"fast")
                        $("#widget-menu-1").animate({"right":"-350"},"fast")
						$("#register-2").animate({"right":"80px"},"fast")
						$(".registerwindow").animate({"right":"80px"},"fast")
                        widgetToggle = false
                    }
                    else{
                        $("body").animate({"left":"-250px"},"fast")
						$("#register-2").animate({"right":"370px"},"fast")
                        $("#widget-menu-1").animate({"right":"0"},"fast")
						$(".registerwindow").animate({"right":"370px"},"fast")
                        widgetToggle = true
                        
                    }

                }
                selectedFrame = frameParent
            }

            function addWidget(path){
                $($(selectedFrame).children()[1]).attr("src",path)
                $($(selectedFrame).children()[0]).hide()
            }

            function addComponents(no){
                switch(no){
                    case 2:
                        $(`<div class="contentbox">
													<div class="element-div">
														<div class="h3-container">
															<h3 class="about"  contenteditable="false"> Our Events</h3>
															<button  onclick="delElement(this)"> <i class="material-icons">close</i></button>
														</div>
														<div class="flex-row-box">
															<div class="frame-box" onclick="loadWidgetMenu(this)">
																<div class="frame-button">
																	<i class="material-icons">add</i>
																</div>
																<iframe></iframe>
															</div>
															<div class="frame-box" onclick="loadWidgetMenu(this)">
																<div class="frame-button">
																	<i class="material-icons">add</i>
																</div>
																<iframe></iframe>
															</div>
															<div class="frame-box" onclick="loadWidgetMenu(this)">
																<div class="frame-button">
																	<i class="material-icons">add</i>
																</div>
																<iframe></iframe>
															</div>
														</div>
													</div>
												</div>`).insertBefore(".faqcontainer")
												
                        break;
                }
            }

            var percentgrowth = 0
            
            function followCount(){
                percentgrowth+= 100 / parseInt($("#denominator").text())
                $("#numerator").text(parseInt($("#numerator").text())+1)
                $("#register-load").css({"width":percentgrowth+"%"})
                
                if($("#numerator").text()=="421"){
                    clearInterval(followCounterInterval)
                }
            }

			function ask(){
				$.ajax({
					url:"http://localhost:4000/customdata",
					method:"get",
					data:{"question":$(".addfaq").val()},
					success:function(data){
						console.log($(".addfaq").val())
					}
				})
				
			}


			function saveData(){

				var eventsRows = $(".image-row")
				var reader = new FileReader();
				var pageData = {

					"type":"event",
					"foundation-name":$("#foundation-name").text(),
					"event-title":$("#event-title").text(),
					"event-head":$("#event-head").text(),
					"event-details":$("#event-details").text(),
					"location-id":$("#location-id").val(),
					"event-date":$("#event-date").val(),
					"phone-no":$("#phone-no").val(),
					"contact-name":$("#contact-name").val(),
					"expected-registration":$("#registration-count").val(),
					"color":currentColor,
					"widgets":[],
					"tags":[]
				}

				var tags = $(".tag")

				tags.each((ind,element)=>{
					if(ind!=tags.length-1){
						pageData["tags"].push($(element).text().split(" ")[0])
					}
					
				})


				console.log(pageData)				

				$.ajax({
					url:"http://localhost:4000/customdata",
					async:true,
					method:"post",
					cache: false,
					data: JSON.stringify(pageData),
					contentType: "application/json",
					processData: false,
					success:function(){
						
						console.log("sent")
					}
				})
					
			}

            function toggleEditingMode(){


                if(editMode){
                    editMode = false
					$(".material-ip").css({"animation":"none"}).addClass("locked-input")
					$(".h3-container button").hide()
					$(".frame-box").css({"pointer-events":"none","animation":"none"})
					$("input[type='file']").css({"pointer-events":"none"})
					$(".del-btn").hide()
					$(".about").css({"border":"none","animation":"none"})
					$("div[contenteditable='true']").css({"animation":"none"}).attr("contenteditable","false")
					$("#add-tag").hide()
					$("#tag-container").hide()
					$(".small-text").css({"animation":"none"})
					$(".edit-mode").val("Edit Page")
					$("#save-changes").text("Edit Page")
					$("#register-count").hide()
					saveData()
                }
                else{
                    editMode = true
					$(".material-ip").css({"animation":"0.6s shake","animation-iteration-count":"infinite"}).removeClass("locked-input")
					$(".small-text").css({"animation":"0.6s shake","animation-iteration-count":"infinite"})
					$("#edit-btn").show()
					$(".h3-container button").show()
					$(".frame-box").css({"pointer-events":"auto"})
					$("input[type='file']").css({"pointer-events":"auto"})
					$(".del-btn").show()
					$(".about").css({"animation":"0.6s shake","animation-iteration-count":"infinite","border":"1px solid rbga(0,0,0,0.1)"})
					$("div[contenteditable='false']").css({"animation":"0.6s shake","animation-iteration-count":"infinite"}).attr("contenteditable","true")
					$("#add-tag").show()
					$("#tag-container").show()
					$(".faqcontainer h3").css({"animation":"none"})
					$(".edit-mode").val("Save Changes")
					$("#save-changes").text("Save Changes")
					$("#register-count").show()
                }
				
				$("p[contenteditable] , h3[contenteditable],h4[contenteditable]").attr("contenteditable",editMode)
            }

            followCounterInterval = setInterval(followCount,1)


			var currentColor = "#3e8e3e"

			function colorChanger(ob){
				
				colorReplace(currentColor,ob.value)
				currentColor = ob.value
				
			}
			
			function colorReplace(findHexColor, replaceWith) {
				// Convert rgb color strings to hex
				// REF: https://stackoverflow.com/a/3627747/1938889
				function rgb2hex(rgb) {
					if (/^#[0-9A-F]{6}$/i.test(rgb)) return rgb;
					rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
					function hex(x) {
					return ("0" + parseInt(x).toString(16)).slice(-2);
					}
					return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
				}

				// Select and run a map function on every tag
				$('*').map(function(i, el) {
					// Get the computed styles of each tag
					var styles = window.getComputedStyle(el);

					// Go through each computed style and search for "color"
					Object.keys(styles).reduce(function(acc, k) {
					var name = styles[k];
					var value = styles.getPropertyValue(name);
					if (value !== null && name.indexOf("color") >= 0) {
						// Convert the rgb color to hex and compare with the target color
						if (value.indexOf("rgb(") >= 0 && rgb2hex(value) === findHexColor) {
						// Replace the color on this found color attribute
						$(el).css(name, replaceWith);
						}
					}
					});
				});
			}
		</script>
		<script>

			var tagCount = 0
			var tagArray = ["Poverty","Donation","Food and Water","Education","Service","Charity","Social Help"]

			$("#tag-container").hover(
				function() {
					$("#tag-suggestions p").show();
				},
				function() {
					$("#tag-suggestions p").hide();
			});

			function getTagsList(){
				tagArray.sort()
				$("p").remove(".tag-fields")
				tagArray.forEach(element => {
					if(element.toLowerCase().match($("#choose-tag").val().toLowerCase())){
						$("#tag-suggestions").append($("<p></p>").text(element).attr("class","tag-fields").click(function(){
							if(tagCount<3){
								var tagTxt = ""
								tagTxt+=element
								if($("#"+tagTxt).length==0){
									$(".tag-holder").append($("<p></p>").attr("class","tag").attr("id",tagTxt).text(tagTxt+"   "+"x").click(function(){
										tagArray.push($(this).text().split(" ")[0])
										$(this).remove()
										tagCount--
									}))
								}
								tagArray.splice(tagArray.indexOf(element),1)
								$("#tag-suggestions").empty()
								getTagsList()
								tagCount++
							}
							else{
								alert("Only 3 tags are allowed!")
							}
						}))
					}
				});
			}

			function displayTagSearch(){
				$("#tag-container").show()
			}
		</script>
</body>
</html>